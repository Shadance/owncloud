#!/bin/bash

OWNCLOUD_PATH=/opt/owncloud
OWNCLOUD_ARCHIVE=owncloud-8.0.3.tar.bz2
DATADIR=/data

apt-get -y install php5-gd php5-json php5-mysql php5-curl php5-intl php5-mcrypt php5-imagick

mysql -uroot -proot <<EOFMYSQL
CREATE DATABASE IF NOT EXISTS owncloud;
GRANT ALL PRIVILEGES ON owncloud.* TO 'owncloud'@'localhost' IDENTIFIED BY 'owncloud';
EOFMYSQL

wget --progress=dot:mega http://apps.syncloud.org/${OWNCLOUD_ARCHIVE}
tar xjf ${OWNCLOUD_ARCHIVE} -C /opt
echo "owncloud dir:"
ls -la ${OWNCLOUD_PATH}

echo "fixing apps permissions"
chown -R www-data. ${OWNCLOUD_PATH}/apps
ls -la ${OWNCLOUD_PATH}/apps/

echo "setup crontab task"
su -s /bin/bash -c "echo \"*/1 * * * * php -f ${OWNCLOUD_PATH}/cron.php\" | crontab -" www-data

sed -i 's/[;]default_charset.*=.*/default_charset = "UTF-8"/g' /etc/php5/apache2/php.ini
sed -i 's/[;]always_populate_raw_post_data.*=.*/always_populate_raw_post_data = -1/g' /etc/php5/cli/php.ini

echo "recreate link for apache"
rm -rf /var/www/owncloud
ln -s ${OWNCLOUD_PATH} /var/www/owncloud