#!/usr/bin/env python
from subprocess import check_output
from os.path import isdir
import psycopg2

app_root = '/opt/app/owncloud/'
database = '/opt/data/owncloud/database'
if not isdir(database):
    print("creating database files")
    check_output('{0}postgresql/bin/initdb {1}'.format(app_root, database), shell=True)
    # check_output('chmod 700 {0}'.format(database), shell=True)
    # check_output('chown -R postgres. {0}'.format(database), shell=True)

with psycopg2.connect(database="postgres", user="postgres", password="postgres") as conn:
    with conn.cursor() as curs:
        print("creating owncloud database")
        curs.execute('CREATE USER owncloud WITH PASSWORD \'owncloud\'')
        curs.execute('CREATE DATABASE owncloud TEMPLATE template0 ENCODING \'UNICODE\'')
        curs.execute('ALTER DATABASE owncloud OWNER TO owncloud')
        curs.execute('GRANT ALL PRIVILEGES ON DATABASE owncloud TO owncloud')
