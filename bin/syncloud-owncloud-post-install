#!/bin/bash

OWNCLOUDPATH=/var/www/owncloud
INSTALLED_FILENAME=${OWNCLOUDPATH}/installed

if [ -e "${INSTALLED_FILENAME}" ]; then
  exit 0
fi

APT_REPO_PREFIX="http://download.opensuse.org/repositories/isv:ownCloud:community"

DATADIR=/data

OS_VERSION=$(lsb_release -sr)
OS_ID=$(lsb_release -si)

echo "install mySQL (set root user password to root)"
echo "mysql-server-5.5 mysql-server/root_password password root" | debconf-set-selections
echo "mysql-server-5.5 mysql-server/root_password_again password root" | debconf-set-selections
apt-get -y install mysql-server-5.5 unzip

echo "fixing mysql"
if [ -f /etc/mysql/debian.cnf ]; then
    cat /etc/mysql/debian.cnf
    echo "first line is corrupted on Cubian"
    sed -i '/fgrep/d' /etc/mysql/debian.cnf
fi
if grep -q inet /etc/group; then
    usermod -a -G inet mysql
fi

mysql -uroot -proot <<EOFMYSQL
CREATE USER 'owncloud'@'localhost' IDENTIFIED BY 'owncloud';
CREATE DATABASE IF NOT EXISTS owncloud;
GRANT ALL PRIVILEGES ON owncloud.* TO 'owncloud'@'localhost' IDENTIFIED BY 'owncloud';
EOFMYSQL

if [[ ${OS_ID} = "Debian" ]]; then
    OWNCLOUD_REPO=${APT_REPO_PREFIX}/Debian_7.0
else
    OWNCLOUD_REPO=${APT_REPO_PREFIX}/xUbuntu_${OS_VERSION}
fi

echo "Using apt repo: $OWNCLOUD_REPO"

wget --no-check-certificate -qO - ${OWNCLOUD_REPO}/Release.key | apt-key add -
echo "deb ${OWNCLOUD_REPO}/ /" > /etc/apt/sources.list.d/owncloud.list

cat <<APTPREF > /etc/apt/preferences
Package: *
Pin: origin download.opensuse.org
Pin-Priority: 610
APTPREF

apt-get update
apt-get -y --no-install-recommends install owncloud

if grep -q inet /etc/group; then
    # add www-data user to inet group
    usermod -a -G inet www-data
fi

echo "owncloud dir:"
ls -la ${OWNCLOUDPATH}

echo "fixing apps permissions"
chown -R www-data. /var/www/owncloud/apps
ls -la ${OWNCLOUDPATH}/apps/

echo "setup crontab task"
su -c "echo \"*/1 * * * * php -f ${OWNCLOUDPATH}/cron.php\" | crontab -" www-data

sed -i 's/[;]default_charset.*=.*/default_charset = "UTF-8"/g' /etc/php5/apache2/php.ini

echo "Installed successfully" > ${INSTALLED_FILENAME}