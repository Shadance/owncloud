#!/bin/bash

OWNCLOUDPATH=/opt/owncloud
INSTALLED_FILENAME=${OWNCLOUDPATH}/installed

if [ -e "${INSTALLED_FILENAME}" ]; then
  exit 0
fi

DATADIR=/data

echo "install mySQL (set root user password to root)"
echo "mysql-server-5.5 mysql-server/root_password password root" | debconf-set-selections
echo "mysql-server-5.5 mysql-server/root_password_again password root" | debconf-set-selections
apt-get -y install mysql-server-5.5 unzip php5-gd php5-json php5-mysql php5-curl php5-intl php5-mcrypt php5-imagick bzip2

echo "fixing mysql"
if [ -f /etc/mysql/debian.cnf ]; then
    cat /etc/mysql/debian.cnf
    echo "first line is corrupted on Cubian"
    sed -i '/fgrep/d' /etc/mysql/debian.cnf
fi
if grep -q inet /etc/group; then
    usermod -a -G inet mysql
fi

mysql -uroot -proot <<EOFMYSQL
CREATE USER 'owncloud'@'localhost' IDENTIFIED BY 'owncloud';
CREATE DATABASE IF NOT EXISTS owncloud;
GRANT ALL PRIVILEGES ON owncloud.* TO 'owncloud'@'localhost' IDENTIFIED BY 'owncloud';
EOFMYSQL

wget http://apps.syncloud.org/owncloud-8.0.3.tar.bz2
tar xjvf owncloud-8.0.3.tar.bz2 -C /opt
if grep -q inet /etc/group; then
    # add www-data user to inet group
    usermod -a -G inet www-data
fi

echo "owncloud dir:"
ls -la ${OWNCLOUDPATH}

echo "fixing apps permissions"
chown -R www-data. /opt/owncloud/apps
ls -la ${OWNCLOUDPATH}/apps/

echo "setup crontab task"
su -c "echo \"*/1 * * * * php -f ${OWNCLOUDPATH}/cron.php\" | crontab -" www-data

sed -i 's/[;]default_charset.*=.*/default_charset = "UTF-8"/g' /etc/php5/apache2/php.ini

echo "Installed successfully" > ${INSTALLED_FILENAME}